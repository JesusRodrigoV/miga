<h2 class="page-title">Parte 3: Costos Indirectos</h2>

<form [formGroup]="form" (ngSubmit)="onSubmit()" class="form-container">


  <div class="items-section" formArrayName="indirectos">
    <div class="section-header">
      <h3>Ítems de Costos Indirectos</h3>
    </div>

    @for (ind of indirectos.controls; track ind; let i = $index) {
      <div class="item-card" [class.collapsed]="itemCollapsed[i]" [formGroupName]="i">

        <div class="item-header" (click)="toggleItem(i)">
          <div class="header-left">
            <span class="item-number">Ítem {{ i + 1 }}</span>
            <span class="item-description">
              {{ ind.get('descripcion')?.value || 'Sin descripción' }}
            </span>
          </div>
          <div class="header-actions">
            <mg-button
              icon="trash-outline"
              [color]="'var(--rojo)'"
              [hoverColor]="'var(--black)'"
              [textColor]="'var(--white)'"
              [fluid]="false"
              (onClick)="removeIndirecto(i); $event.stopPropagation()"
            >
              <ion-icon name="trash-outline"></ion-icon>
          </mg-button>
            <ion-icon name="chevron-down-outline" class="collapse-icon"></ion-icon>
          </div>
        </div>

        <div class="item-body">

          <div class="form-grid">
            <div class="full-width">
              <mg-input
                label="Descripción del ítem"
                formControlName="descripcion"
                [invalid]="!!(ind.get('descripcion')?.invalid && ind.get('descripcion')?.touched)"
                errorMessage="Campo requerido"
                [fluid]="true"
              />
            </div>

            <mg-input
              label="Costo Mensual (Bs)"
              type="number"
              formControlName="costoMensual"
              [invalid]="!!(ind.get('costoMensual')?.invalid && ind.get('costoMensual')?.touched)"
              errorMessage="Valor inválido"
              [fluid]="true"
            />

            <mg-input
              label="Días Calculados"
              type="number"
              formControlName="diasCalculados"
              [invalid]="!!(ind.get('diasCalculados')?.invalid && ind.get('diasCalculados')?.touched)"
              errorMessage="Valor inválido"
              [fluid]="true"
            />

            <mg-input
              label="Horas Requeridas"
              type="number"
              formControlName="horasRequeridas"
              [invalid]="!!(ind.get('horasRequeridas')?.invalid && ind.get('horasRequeridas')?.touched)"
              errorMessage="Valor inválido"
              [fluid]="true"
            />
          </div>

          <div class="calculated-section">
            <div class="section-subtitle">
              <ion-icon name="calculator-outline"></ion-icon>
              Valores Calculados Automáticamente
            </div>

            <div class="form-grid">
              <mg-input
                label="Costo por Día (Bs)"
                type="number"
                formControlName="costoPorDia"
                [fluid]="true"
                [disabled]="true"
              />

              <mg-input
                label="Costo por Hora (Bs)"
                type="number"
                formControlName="costoPorHora"
                [fluid]="true"
                [disabled]="true"
              />

              <mg-input
                label="Costo Neto (Bs)"
                type="number"
                formControlName="costoNeto"
                [fluid]="true"
                [disabled]="true"
              />
            </div>
          </div>

        </div>
      </div>
    }

    <div class="add-item-wrapper">
      <mg-button
        label="Agregar Ítem"
        icon="add-circle-outline"
        [color]="'var(--verde-medio)'"
        [hoverColor]="'var(--black)'"
        [textColor]="'var(--white)'"
        [fluid]="false"
        [buttonProps]="{ type: 'button' }"
        (onClick)="addIndirecto()"
      />
    </div>
  </div>

  @if (indirectos.length > 0) {
    <div class="resumen-section">
      <h3>
        <ion-icon name="stats-chart-outline"></ion-icon>
        Resumen de Totales
      </h3>

      <div class="resumen-grid">
        <div class="resumen-card">
          <div class="resumen-label">
            <ion-icon name="calendar-outline"></ion-icon>
            Total Costo Mensual
          </div>
          <div class="resumen-valor">
            {{ totalCostoMensual | number: '1.2-2' }}
            <span class="moneda">Bs</span>
          </div>
        </div>

        <div class="resumen-card destacado">
          <div class="resumen-label">
            <ion-icon name="cash-outline"></ion-icon>
            Total Costo Neto
          </div>
          <div class="resumen-valor">
            {{ totalCostoNeto | number: '1.2-2' }}
            <span class="moneda">Bs</span>
          </div>
        </div>
      </div>
    </div>
  }

  <div class="form-actions">
    <mg-button
      label="Cancelar"
      [color]="'var(--rojo)'"
      [hoverColor]="'var(--black)'"
      [textColor]="'var(--white)'"
      [fluid]="false"
    />

    <mg-button
      label="Guardar y continuar"
      icon="save-outline"
      [color]="'var(--verde-medio)'"
      [hoverColor]="'var(--black)'"
      [textColor]="'var(--white)'"
      [disabled]="form.invalid"
      [loading]="store.isLoading()"
      [fluid]="false"
      [buttonProps]="{ type: 'submit' }"
    />
  </div>

</form>
